var request = require("request");

function CatBot() {}

CatBot.prototype.handleRequest = function (req, res, next) {
	// get args
	var userText = req.body.text,
		argsStr = userText.split(":")[1];

	if (argsStr.trim()) {
		var args = argsStr.split(" ");

		var command = args[0] || ""

		switch (command) {
		case "fact":
			this.fact(res);
			break;
		case "pic":
			this.pic(req, res, false);
		case "gif":
			this.pic(req, res, true);
			break;
		case "pet":
			this.purr(res);
			break;
		default:
			return res.status(404).send("Not found");
			break;
		}
	}
};

CatBot.prototype.purr = function (res) {
	return res.status(200).json({
		text: "purrrrr"
	});
};

CatBot.prototype.pic = function (req, res, gif) {
	var botPayload = {
			text: ""
		};

	var url = "http://thecatapi.com/api/images/get?format=html";

	if(gif) {
		url += "&type=gif"
	}

	request({
		url: url
	}, function (error, resp, body) {
		if (!error && resp.statusCode === 200) {
			var regex = /src\s*=\s*"(.+?)"/, // regxp for extractng src attr
				src = regex.exec(body)[1];
			botPayload.text = src;

			return res.status(200).json(botPayload);
		}
	})
};

CatBot.prototype.fact = function (res) {
	var botPayload = {
		text: ""
	};

	request({
		url: "http://catfacts-api.appspot.com/api/facts",
		json: true
	}, function (error, resp, body) {
		if (!error && resp.statusCode === 200) {
			var fact = body.facts[0];

			botPayload.text = fact;

			return res.status(200).json(botPayload);
		}
	})
};

module.exports = CatBot;