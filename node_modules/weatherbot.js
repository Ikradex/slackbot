var request = require("request"),
	mdtable = require('markdown-table'),
	vsprintf = require("sprintf-js").vsprintf;

function WeatherBot() {
	this.getCurrent = function (req, res, next) {
		var botPayload = {
			text: " ",
			attachments: []
		};

		var userText = req.body.text,
			args = userText.split(" ");
		args.shift();

		var cityName = args[0] || "cork",
			countryName = args[1] || "ireland"

		request({
			url: "http://api.openweathermap.org/data/2.5/weather?q=" + [cityName, countryName].join(","),
			json: true
		}, function (error, resp, body) {
			if (!error && resp.statusCode === 200) {
				var reportJson = body;

				if (reportJson.cod === 200) {
					var city = reportJson.name,
						cityID = reportJson.id,
						countryCode = reportJson.sys.country,
						weatherMain = reportJson.weather[0].main,
						weatherDesc = reportJson.weather[0].description,
						icon = reportJson.weather[0].icon;

					var summaryTable = mdtable([
						["Temp", reportJson.main.temp + "&#176;"],
						["Humidity", reportJson.main.humidity + " %"],
						["Pressure", reportJson.main.pressure + " hpa"],
						["Wind", reportJson.wind.speed + " m/s"]
					]);

					var attachment = {
						"fallback": vsprintf("Current weather for %s, %s: %s", [city, countryCode, weatherDesc]),
						"pretext": vsprintf("#%s, %s", [city, countryCode]),
						"title": weatherMain,
						"title_link": "openweathermap.org/city/",
						"text": summaryTable,
						"color": "#439FE0",
						"mrkdwn_in": ["title", "text", "pretext"]
					}

					botPayload.attachments.push(attachment);
					return res.status(200).json(botPayload);
				}
			}
		});
	}
}

module.exports = WeatherBot;